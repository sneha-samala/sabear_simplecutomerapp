// Scripted Pipeline (Jenkinsfile)

node {
    // Global variables (shared across stages)
    def artifactPath = ''
    def pomGroupId = ''
    def pomArtifactId = ''
    def pomVersion = ''
    def pomPackaging = ''

    try {
        stage('Git Clone') {
            git branch: 'feature-1.1',
                url: 'https://github.com/betawins/sabear_simplecutomerapp.git'
        }

        stage('SonarQube Analysis') {
            withSonarQubeEnv('sonar') {  // must match SonarQube server name in Jenkins config
                def scannerHome = tool 'sonar-scanner'
                sh """
                    ${scannerHome}/bin/sonar-scanner \
                    -Dsonar.projectKey=Ncodeit \
                    -Dsonar.projectName=Ncodeit \
                    -Dsonar.projectVersion=2.0 \
                    -Dsonar.sources=/var/lib/jenkins/workspace/${env.JOB_NAME}/src/ \
                    -Dsonar.binaries=target/classes/com/visualpathit/account/controller/ \
                    -Dsonar.junit.reportsPath=target/surefire-reports \
                    -Dsonar.jacoco.reportPath=target/jacoco.exec \
                    -Dsonar.java.binaries=src/com/room/sample
                """
            }
        }

        stage('Maven Compilation & Package') {
            withMaven(jdk: 'MVN_HOME') {  // optional: use if you have Maven configured this way
                sh 'mvn -Dmaven.test.failure.ignore=true clean install'
            }
        }

        stage('Publish to Nexus') {
            // Extract POM values
            pomGroupId = sh(script: "mvn help:evaluate -Dexpression=project.groupId -q -DforceStdout", returnStdout: true).trim()
            pomArtifactId = sh(script: "mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout", returnStdout: true).trim()
            pomVersion = sh(script: "mvn help:evaluate -Dexpression=project.version -q -DforceStdout", returnStdout: true).trim()
            pomPackaging = sh(script: "mvn help:evaluate -Dexpression=project.packaging -q -DforceStdout", returnStdout: true).trim()

            artifactPath = sh(script: "ls target/*.${pomPackaging} | head -n 1", returnStdout: true).trim()

            if (fileExists(artifactPath)) {
                echo "Uploading artifact: ${artifactPath}"
                echo "Group: ${pomGroupId} | Artifact: ${pomArtifactId} | Version: ${pomVersion} | Type: ${pomPackaging}"

                nexusArtifactUploader(
                    nexusVersion: 'nexus3',
                    protocol: 'http',
                    nexusUrl: '15.207.103.131:8081',
                    groupId: pomGroupId,
                    version: pomVersion,
                    repository: 'simple_customerapp',
                    credentialsId: 'nexus-server',
                    artifacts: [
                        [artifactId: pomArtifactId, classifier: '', file: artifactPath, type: pomPackaging],
                        [artifactId: pomArtifactId, classifier: '', file: 'pom.xml', type: 'pom']
                    ]
                )
            } else {
                error "Main artifact not found: target/*.${pomPackaging}"
            }
        }

        stage('Slack Notification') {
            // Simple success notification (you can customize with build status)
            slackSend(
                color: '#00FF00',
                message: "Build *SUCCESS* - ${env.JOB_NAME} #${env.BUILD_NUMBER}\n" +
                         "Branch: feature-1.1\n" +
                         "Nexus: ${pomArtifactId}-${pomVersion}.${pomPackaging} uploaded\n" +
                         "More info: ${env.BUILD_URL}"
            )
        }

        stage('Deploy to Tomcat') {
            withCredentials([usernamePassword(
                credentialsId: 'tomcat_credentials',
                usernameVariable: 'TOMCAT_USR',
                passwordVariable: 'TOMCAT_PSW'
            )]) {
                // Undeploy old version (ignore failure)
                sh """
                    curl --user \${TOMCAT_USR}:\${TOMCAT_PSW} \
                         --fail --silent \
                         "http://13.202.46.203:8080/manager/text/undeploy?path=/SimpleCustomerApp" \
                         || echo "No previous deployment found - continuing"
                """

                // Deploy new version
                sh """
                    curl --user \${TOMCAT_USR}:\${TOMCAT_PSW} \
                         --fail \
                         --upload-file ${artifactPath} \
                         "http://13.202.46.203:8080/manager/text/deploy?path=/SimpleCustomerApp&update=true"
                """

                echo "Deployment completed!"
                echo "Application available at: http://13.202.46.203:8080/SimpleCustomerApp"
            }
        }

    } catch (Exception e) {
        currentBuild.result = 'FAILURE'
        slackSend(
            color: '#FF0000',
            message: "Build *FAILED* - ${env.JOB_NAME} #${env.BUILD_NUMBER}\n" +
                     "Error: ${e.getMessage()}\n" +
                     "Check console: ${env.BUILD_URL}console"
        )
        throw e
    } finally {
        cleanWs()
    }
}
